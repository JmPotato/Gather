{% extends 'base.html' %}

{% block title %}{{ handler.settings['bbs_title'] }} > {{ post['title'] }}{% end %}

{% block head %}
<link rel='stylesheet' href='{{ static_url("css/postview.css") }}' type='text/css'/>
<script src='{{ static_url("js/highlight.pack.js") }}' type="text/javascript"></script>
<link rel='stylesheet' href='{{ static_url("css/highlight.css") }}' type='text/css'/>
<script type="text/javascript">
    postID="{{ post['_id'] }}";
</script>
{% end %}

{% block nav %}
<li><a href='/'>主页</a></li>
<li class='active'><a href='/topics'>主题</a></li>
<li><a href='/tag'>标签</a></li>
{% end %}

{% block breadcrumb %}
<li><a href="/">{{ handler.settings['bbs_title'] }}</a> <span class="divider">/</span></li>
<li><a href="/topics">主题</a> <span class="divider">/</span></li>
<li class="active">{{ post['title'] }}</li>
{% end %}

{% block content %}
<section class='box' id='article'>
    <article>
        <header>
            <table>
                <tbody>
                <tr>
                    <td>
                        <h1>{{ post['title'] }}</h1>
                        <a href="/user/{{ post['author'] }}">{{ post['author'] }}</a>创建于{{ time_span(post['posttime']) }}<br />
                        <span class='tags'>
                        {% for tag in post['tags'] %}
                        <a href="/tag/{{ tag }}">{{ tag }}</a>
                        {% end %}
                        </span>
                        {% if current_user and current_user['username'] in admin_list %}
                        <div id="changetag" class="modal hide fade">
                            <div class="modal-header">
                                <a class="close" data-dismiss="modal" >&times;</a>
                                <h3>修改Tags</h3>
                            </div>
                            <form action="/admin/post/changetag/{{ post['_id'] }}" method='post'>
                            <div class="modal-body">
                                <input style='width:99%;' type='text' name='tags' placeholder="请输入标签。标签间使用空格或英文逗号(,)或(/)分割" required x-webkit-speech>
                            </div>
                            <div class="modal-footer">
                                {{ xsrf_form_html() }}
                                <button type='submit' class="btn btn-danger">更改Tags</button>
                            </div>
                            </form>
                        </div>
                        <a data-toggle="modal" href="#changetag" class="label label-important">修改Tags</a>
                        {% end %}
                    </td>
                    <td class='avatar'>
                        <img src='http://gravatar.com/avatar/{{ db.users.find_one({"username":post["author"]})["hashed_email"] }}?s=72' /></a>
                    </td>
                </tr>
                </tbody>
            </table>
        </header>
        {{ post['content'] }}
        <footer>
            <div class="left">
                {% if current_user %}
                {% if post['_id'] in current_user['postmark'] %}
                <a class="label label-important mark" id="mark">取消收藏</a>
                {% else %}
                <a class="label mark" id="mark">收藏</a>
                {% end %}
                {% end %}
            </div>
            <div class="right">
                <a href="#;" onclick="window.open('https://twitter.com/share?url='+window.location.href+'&related=v2ex&hashtags=share&text={{ post["title"] }}', '_blank', 'width=700,height=370'); recordOutboundLink(this, 'Share', 'twitter.com');" class="label">Tweet</a>
                <a href="javascript:void(function(){var d=document,e=encodeURIComponent,s1=window.getSelection,s2=d.getSelection,s3=d.selection,s=s1?s1():s2?s2():s3?s3.createRange().text:'',r='http://www.douban.com/recommend/?url='+e(d.location.href)+'&title='+e(d.title)+'&sel='+e(s)+'&v=1',x=function(){if(!window.open(r,'douban','toolbar=0,resizable=1,scrollbars=yes,status=1,width=700,height=330'))location.href=r+'&r=1'};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})()" class="label">Douban</a>
                <a href="#;" onclick="window.open('http://service.weibo.com/share/share.php?url='+window.location.href+'&title{{ post["title"] }}', '_blank', 'width=700,height=370'); recordOutboundLink(this, 'Share', 'weibo.com');" class="label">Weibo</a>
                <a href="#;" onclick="window.open('http://www.instapaper.com/edit?url='+window.location.href+'&title={{ post["title"] }}', '_blank', 'width=700,height=370'); recordOutboundLink(this, 'Share', 'instapaper.com');" class="label">InstaPaper</a>
                {% if current_user and current_user['username'] in admin_list %}
                <a href="/admin/post/kill/{{ post['_id'] }}" class='label label-important'>和谐</a>
                {% end %}
            </div>
            <!-- 打算放些用户打分什么的-->
        </footer>
    </article>
</section>
{% if len(comments) > 0 %}
<section class='box'>
    <table id="comments" class='item-list'>
        {% for comment in comments %}
        <tr>
            <td class='avatar'>
                <img src="http://gravatar.com/avatar/{{ db.users.find_one({'username':comment['author']})["hashed_email"] }}?s=48" /
            </td>
            <td id="reply-{{ comment['location'] }}">
                <article>
                    <header>
                        <div class='left'>
                            <a href="/user/{{ comment['author'] }}">{{ comment['author'] }}</a>
                        </div>
                        <div class='right'>
                            #{{ comment['location'] }}     发表于{{ time_span(comment['posttime']) }}
                            {% if current_user and current_user['username'] in admin_list %}
                            <a href="/admin/post/kill/{{ post['_id'] }}/{{ comment['location'] }}" class="label label-important">和谐</a>
                            {% end %}
                        </div>
                    </header><br />
                    {{ comment['content'] }}
                </article>
            </td>
        </tr>
        {% end %}
    </table>
</section>
{% end %}
{% if current_user %}
<section class='box'>
    <form action="" method="post">
    {{ xsrf_form_html() }}
    {{ modules.Edit() }}
    </form>
</section>
{% end %}
{% end %}
{% block sidebar %}
<section class="box">
    <header>
        <h3>相关主题</h3>
    </header>
    <ul>
        {% if len(likely) > 0%}
        {% for x in likely %}
        <li><a href="/topics/{{ x['_id'] }}">{{ x['title'] }}</a></li>
        {% end %}
        {% else %}
        没有相关主题
        {% end %}
    </ul>
</section>
<script src='{{ static_url("js/markpost.js") }}' type="text/javascript"></script>
{% end %}



