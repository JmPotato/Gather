{% extends 'base.html' %}

{% block title %}{{ handler.settings['bbs_title'] }} > {{ post['title'] }}{% end %}

{% block head %}
<script src='{{ static_url("wmd/wmd.js") }}' type="text/javascript"></script>
<link rel='stylesheet' href='{{ static_url("postview.css") }}' type='text/css'/>
<script src='{{ static_url("highlight.pack.js") }}' type="text/javascript"></script>
<link rel='stylesheet' href='{{ static_url("highlight.css") }}' type='text/css'/>
<script type="text/javascript">
    wmd_options = {
        output: "Markdown",
        lineLength: 80,
        buttons: "bold italic | link blockquote code image | ol ul heading hr",
        autostart: true
    };
    hljs.tabReplace = '    ';
    hljs.initHighlightingOnLoad();
    commentNum={{ len(post['comments']) }};
</script>
{% end %}

{% block breadcrumb %}
<li><a href="/">{{ handler.settings['bbs_title'] }}</a> <span class="divider">/</span></li>
<li class="active">{{ post['title'] }}</li>
{% end %}

{% block body %}
<div class='container'>
  <div class='row'>
    <div class='span8 offset1'>
      <section class='box'>
        <article id='topic-379'>
          <header>
            <table class='clear-table'>
              <tbody>
                <tr>
                  <td class='avatar'>
                    <img src='http://gravatar.com/avatar/{{ md5(db.users.find_one({"username":post["author"]})["email"]).hexdigest() }}.png?r=G&amp;s=72' /></a>
                  </td>
                  <td>
                    <h1>{{ post['title'] }}</h1>
                    {% if len(post['tags']) > 0 %}
                    <span class='tags'>
                      {% for tag in post['tags'] %}
                      <a href="/tag/{{ tag }}">{{ tag }}</a>
                      {% end %}
                    </span>
                    {% end %}
                    <a href="/user/{{ post['author'] }}">{{ post['author'] }}</a>创建于{{ time_span(post['posttime']) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </header>
          {{ post['content'] }}
          <footer>
            <!-- 打算放些用户打分什么的-->
          </footer>
        </article>
      </section>
      <section class='box'>
        <table id="comments" class='table item-list'>

        </table>
        <button id='more' class='btn btn-info'>官人，论家还要嘛。</button>
      </section>
      <section class='box'>
        {{ xsrf_form_html() }}
        <div id='markdown-g' class='control-group offset1'>
          <div class='controls'>
            <textarea class="span6" style="height:200px;" id='markdown' name='markdown'></textarea>
            <textarea style="display:none;" name="html" id="html" class="wmd-output"></textarea>
          </div>
          <div id="markdown-t" class="box controls">
            <span class="help-inline">起码也要输入几个字嘛~</span>
          </div>
        </div>
        <div class="well">
          <h2>预览(焦点离开输入框后刷新)</h2>
          <div id="preview"></div>
        </div>
        <button id='submit' class='btn btn-primary'>很好，我要发表</button>.btn-info
      </section>
    </div>
    <div class='span2'>
      <section class="box">
        我就是来卖萌的
      </section>
    </div>
  </div>
</div>
<script type="text/javascript">
  ajaxNum=1;
  function ajaxComment()
  {
    $.post("/topics/{{ post['_id'] }}",{_xsrf:$("input[name='_xsrf']").val(),
                                        start_num:ajaxNum},
    function(data){
      $("#comments").append(data);
    },"html");
    ajaxNum=ajaxNum+10;
    alert(ajaxNum+" "+commentNum);
    if(ajaxNum>commentNum)
    {
      $("#more").hide();
    }
    else
    {
      $("#more").show();
    }
  }
  ajaxComment();
  $("#more").click(function(){
    ajaxComment();
  });
  $("#markdown").blur(function(){
    checkInput("#markdown",!$(this).val());
    $.post("/markdown",{_xsrf:$("input[name='_xsrf']").val(),
                        md:$("#markdown").val()},
    function(data){
      $("#preview").html(data);
    },"html");
  });
  $("#markdown-t").hide();
  $("#submit").click(function(){
    readySubmit=true;
    $("#markdown").blur();
    if(!readySubmit)
      return false;
    $.post("/topics/{{ post['_id'] }}/comment",{_xsrf:$("input[name='_xsrf']").val(),
                                                markdown:$("#markdown").val(),
                                                html:$("#html").val()},
    function(data){
      alert(data.message);
      if(data.status=="success")
        location.reload();
    },"json");
    return false;
  });
</script>
{% end %}


